<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{/layouts/layout.html}">
<th:block layout:fragment="content">

<div class="custom-body container-xxl flex-grow-1 container-p-y">

	<h4 class="mb-4"><b>생산관리 / 대시보드</b></h4>

  	<style>
	    .dashboard-card {
	      border-radius: 12px;
	      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
	      padding: 20px;
	      background: #fff;
	      height: 120px;
	    }
	    .chart-card {
	      border-radius: 12px;
	      background: #fff;
	      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
	      padding: 20px;
	    }
	    .section-title {
	      font-size: 18px;
	      font-weight: 600;
	      margin-bottom: 15px;
	    }
  	</style>

    <!-- KPI SECTION -->
 	<div class="row g-3 mb-4">
 		<div class="col-md-3">
 			<div class="dashboard-card text-center">
 				<div>오늘 작업지시</div>
 				<h3 class="mt-2" th:text="${dashboard.todayOrders}">0</h3>
      		</div>
    	</div>
    	<div class="col-md-3">
      		<div class="dashboard-card text-center">
	        	<div>진행 중</div>
	        	<h3 class="mt-2" th:text="${dashboard.inProgress}">0</h3>
      		</div>
    	</div>
   		<div class="col-md-3">
   			<div class="dashboard-card text-center">
	       		<div>완료</div>
	        	<h3 class="mt-2" th:text="${dashboard.completed}">0</h3>
      		</div>
    	</div>
    	<div class="col-md-3">
      		<div class="dashboard-card text-center">
		        <div>지연 공정</div>
		        <h3 class="mt-2 text-danger" th:text="${dashboard.delayed}">0</h3>
      		</div>
    	</div>
  	</div>

	<!-- 그래프 영역 -->
  	<div class="row g-4 mb-4">
		<div class="col-md-6">
	    	<div class="chart-card">
	        	<div class="section-title">라인별 생산량</div>
	        	<div id="lineChart"></div>
	      	</div>
	    </div>
	
	    <div class="col-md-6">
	      	<div class="chart-card">
		        <div class="section-title">불량 비율</div>
		        <div id="defectChart"></div>
	      	</div>
	    </div>
  	</div>

    <!-- 공정 현황 테이블 -->
  	<div class="chart-card mb-4">
    	<div class="section-title">공정 진행 현황</div>

	    <table class="table table-hover text-center">
	    	<thead class="table-light">
		        <tr>
		        	<th>작업지시</th>
		            <th>제품</th>
		            <th>계획수량</th>
		            <th>양품</th>
		            <th>불량</th>
		            <th>진행률</th>
		            <th>현재공정</th>
		            <th>상태</th>
		        </tr>
	      	</thead>
	      	<tbody>
		        <!-- 데이터 없을 때 -->
		        <tr th:if="${#lists.isEmpty(dashboard.processList)}">
		            <td colspan="8" class="text-muted">데이터가 없습니다.</td>
		        </tr>
		
		        <!-- 데이터 있을 때 -->
		        <tr th:each="row : ${dashboard.processList}">
		      	    <td th:text="${row.orderId}">WO-0001</td>
		            <td th:text="${row.prdName}">향수A</td>
		            <td th:text="${row.planQty}">1000</td>
		            <td th:text="${row.goodQty}">900</td>
		            <td th:text="${row.defectQty}">0</td>
		            <td>
					  <div class="progress" style="height: 18px;">
					    <div class="progress-bar bg-success"
					         role="progressbar"
					         th:style="'width:' + ${row.progressRate} + '%'"
					         th:text="${row.progressRate + '%'}"></div>
					  </div>
					</td>
		            <td th:text="${row.currentProcess}">배합</td>
		            <td th:text="${row.status}">IN_PROGRESS</td>
		        </tr>
	        </tbody>
	    </table>
  	</div>
</div> 

<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {

    // ==== 1. 서버 데이터 바인딩 ====
    let lineLabels  = /*[[${dashboard.lineLabels}]]*/ [];
    let lineSeries  = /*[[${dashboard.lineSeries}]]*/ [];
    let goodTotal   = /*[[${dashboard.goodQtyTotal}]]*/ 0;
    let defectTotal = /*[[${dashboard.defectQtyTotal}]]*/ 0;

    console.log('lineLabels:', lineLabels);
    console.log('lineSeries:', lineSeries);
    console.log('goodTotal, defectTotal:', goodTotal, defectTotal);

    // 혹시 엘리먼트 못 찾으면 그냥 리턴
    const lineEl   = document.querySelector("#lineChart");
    const defectEl = document.querySelector("#defectChart");
    if (!lineEl || !defectEl) {
      console.error("차트 DOM 요소를 찾지 못했습니다.");
      return;
    }

    // ==== 2. 라인별 생산량 ====
    var lineChart = new ApexCharts(lineEl, {
      chart: { type: 'line', height: 280 },
      series: [{ name: "생산량", data: lineSeries }],
      xaxis: { categories: lineLabels }
    });
    lineChart.render();

    // ==== 3. 불량 비율 도넛 ====
    var defectChart = new ApexCharts(defectEl, {
      chart: { type: 'donut', height: 280 },
      labels: ["양품", "불량"],
      series: [goodTotal, defectTotal],
      colors: ["#00c8a2", "#ff6384"]
    });
    defectChart.render();

  });
</script>

</th:block>
</th:block>