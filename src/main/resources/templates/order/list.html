<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/layout.html}">
<head>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/line-awesome/1.3.0/line-awesome/css/line-awesome.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
  body {
    background: #f4f3fb;
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    color: #2f2b43;
  }

  .title {
    font-size: 1.8em;
    margin-bottom: 1.8rem;
    color: #697a8d;
    font-weight: 500;
  }

  .order-card {
    border-radius: 12px;
    border: 1px solid #e2e1f3;
    background: #ffffff;
    box-shadow: 0 10px 25px rgba(80, 72, 180, 0.08);
    padding: 16px 18px;
    margin-bottom: 18px;
  }

  .order-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .card-title {
    font-size: 1.6em;
    font-weight: 600;
    color: #41388f;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .yeoun-badge-outline {
    border-radius: 999px;
    border: 1px solid rgba(111, 92, 236, 0.4);
    color: #6f5cec;
    padding: 2px 10px;
    font-size: 15px;
    background: rgba(111, 92, 236, 0.04);
  }

  .status-badge {
    width: 90px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    padding: 3px 20px;
  }

  .status-create     { background: #e7eef7; color: #3a5a8a; }
  .status-release    { background: #f0eaff; color: #6a4cc3; }
  .status-progress   { background: #e6f5ec; color: #15803d; }
  .status-complete   { background: #e8f1ff; color: #1d4ed8; }
  .status-cancel     { background: #fdecec; color: #c0392b; }


  .form-label {
    font-size: 13px;
    font-weight: 500;
    color: #514d7a;
    margin-bottom: 4px;
  }

  .form-control,
  .form-select {
    font-size: 13px;
    border-radius: 8px;
    border-color: #d9d8f2;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: #6f5cec;
    box-shadow: 0 0 0 0.15rem rgba(111, 92, 236, 0.2);
  }

  .form-text {
    font-size: 11px;
    color: #9a96c0;
  }

  .btn-yeoun-primary {
    font-size: 15px;               /* 버튼 글자 키움 */
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, #6f5cec, #9479ff);
    color: white;
  }
  
  .btn-yeoun-primary:hover {
  	background: linear-gradient(135deg, #b8b3ff, #d9d4ff);
  	color: #5c4ac7 !important;
  }

  .btn-yeoun-outline {
    border-radius: 999px;
    border: 1px solid #c9c6f3;
    background: #fff;
    color: #655dc0;
    font-size: 13px;
    padding: 8px 14px;
  }

  .badge-priority {
    border-radius: 999px;
    font-size: 11px;
    padding: 3px 8px;
    background: #fdf4e2;
    color: #d97907;
  }

  .search-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .search-row .form-control,
  .search-row .form-select {
    font-size: 12px;
    height: 32px;
    padding: 4px 10px;
  }

  .search-row .btn {
    height: 32px;
    font-size: 12px;
    padding: 4px 10px;
  }

  /** modal **/

  /* 메인 카드형 모달 */
  .yeoun-modal {
    border-radius: 18px;
    border: none;
    background: #ffffff;
    box-shadow: 0 15px 35px rgba(90, 75, 180, 0.15);
  }

  /* 헤더 */
  .yeoun-modal-header {
    padding: 18px 24px;
    border-bottom: 1px solid #eeeafc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title-wrap i {
    color: #6a5acd;
    font-size: 20px;
    margin-right: 6px;
  }

  .modal-title {
    font-weight: 600;
    color: #3b336d;
  }
  
  /* 작업자 배치 */
  .worker-flow-container {
	  display: flex;
	  justify-content: space-between;
	  align-items: stretch;
	  gap: 14px;
	  padding: 16px;
	  background: #faf9ff;
	  border: 1px solid #e2defc;
	  border-radius: 14px;
	  box-shadow: 0 8px 18px rgba(110, 94, 230, 0.08);
	}
	
	.flow-item {
	  flex: 1;
	  min-width: 160px;
	  background: #ffffff;
	  border-radius: 12px;
	  border: 1px solid #dedbf7;
	  padding: 14px 12px;
	  text-align: center;
	  box-shadow: 0 5px 12px rgba(150, 140, 240, 0.10);
	}
	
	.flow-title {
	  font-size: 15px;
	  font-weight: 700;
	  color: #5a51c8;
	  margin-bottom: 3px;
	}
	
	.flow-desc {
	  font-size: 12px;
	  color: #7e78aa;
	  margin-bottom: 10px;
	}
	
	.flow-select {
	  width: 100%;
	  padding: 8px 10px;
	  border-radius: 8px;
	  border: 1px solid #d1cdf6;
	  background: #fafaff;
	  font-size: 13px;
	  color: #4b4470;
	}
	
	.flow-select:focus {
	  border-color: #7b6fff;
	  box-shadow: 0 0 0 0.15rem rgba(130, 115, 255, 0.25);
	}

  

  /* 바디 */
  .yeoun-modal-body {
    padding: 24px 28px;
  }

  /* 탭 */
  .yeoun-tabs .nav-link {
    border: none;
    color: #867ccc;
    font-weight: 500;
    padding: 10px 18px;
    border-radius: 8px 8px 0 0;
  }

  .yeoun-tabs .nav-link.active {
    color: #4b3fbf;
    background: #f3f1ff;
    font-weight: 600;
  }

  /* 상세 */
	.wo-detail {
	    display: flex;
	    flex-direction: column;
	    gap: 20px;
	    padding: 10px 5px;
	}
	
	/* 공통 텍스트 */
	.wo-detail label {
	    font-size: 13px;
	    font-weight: 600;
	    color: #776fb5;
	    margin-bottom: 4px;
	}
	
	.wo-detail .value {
	    font-size: 15px;
	    padding: 6px 0;
	    color: #3f3b67;
	}
	
	.value.strong {
	    font-size: 18px;
	    font-weight: 700;
	    color: #5c53c4;
	}
	
	/* ===== Header ===== */
	.wo-header {
	    display: grid;
	    grid-template-columns: 1.3fr 1fr 0.7fr;
	    gap: 20px;
	    padding-bottom: 12px;
	    border-bottom: 1px solid #eceaff;
	}
	
	/* ===== 일반 행 ===== */
	.wo-row {
	    display: flex;
	    gap: 40px;
	}
	
	.wo-col {
	    flex: 1;
	}
	
	/* ===== 공정 섹션 전체 ===== */
	.wo-process-group {
	    position: relative;
	}
	
	/* 선 + 점 컨테이너 */
	.process-line {
	    position: relative;
	    margin: 8px 0 18px 0;
	    height: 16px;
	}
	
	/* 가로 선 */
	.process-line::before {
	    content: "";
	    position: absolute;
	    top: 8px; /* 텍스트 아래 정확히 */
	    left: 0;
	    right: 0;
	    height: 2px;
	    background: #dcd6ff;
	}
	
	/* 점 스타일 */
	.process-line .dot {
	    width: 10px;
	    height: 10px;
	    background: #b3a6ff;
	    border-radius: 50%;
	    position: absolute;
	    top: 3px;
	}
	
	/* 점 5개 균등 배치 */
	.process-line .dot:nth-child(1) { left: 7.5%; }
	.process-line .dot:nth-child(2) { left: 24%; }
	.process-line .dot:nth-child(3) { left: 41%; }
	.process-line .dot:nth-child(4) { left: 58%; }
	.process-line .dot:nth-child(5) { left: 74.5%; }
	.process-line .dot:nth-child(6) { left: 92%; }
	
	.dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    position: absolute;
    top: 3px;
    transition: all .25s ease;
	}
	
	/* 상태별 색 */
	
	.dot.done {
	    background: #6c5ce7; /* 완료 */
	}
	
	.dot.current {
	    background: #a29bfe; /* 현재 */
	}
	
	.dot.future {
	    background: #e5e2ff; /* 미도달 */
	}
	
	/* 상태별 선색 */
	.process-line::before {
	    content: "";
	    position: absolute;
	    top: 8px;
	    left: 0;
	    right: 0;
	    height: 2px;
	    background: #e5e2ff; /* default: 미래 */
	    transition: all .25s ease;
	}
	
	.process-line.done::before {
	    background: #6c5ce7;
	}
	
	.process-line.partial::before {
	    background: linear-gradient(
	        to right,
	        #6c5ce7 0% var(--progress),
	        #e5e2ff var(--progress) 100%
	    );
	}

	/* 박스들을 가로로 균등 배치 */
	.process-boxes {
	    display: grid;
	    grid-template-columns: repeat(6, 1fr);
	    gap: 14px;
	    margin-top: 16px;
	}
	
	/* 박스 디자인 */
	.proc {
	    background: #f7f5ff;
	    border: 1px solid #e6e2ff;
	    border-radius: 12px;
	    padding: 16px 10px;
	    display: flex;
	    flex-direction: column;
	    align-items: center;
	    justify-content: center;	
	    min-height: 85px;
	}
	
	/* 공정 제목 */
	.proc-title {
	    font-size: 12px;
	    font-weight: 600;
	    color: #6c63b7;
	    margin-bottom: 6px;
	    text-align: center;
	}
	
	/* 작업자 이름 */
	.proc-value {
	    font-size: 15px;
	    color: #3f3b67;
	    font-weight: 500;
	    text-align: center;
	}

	
	/* ===== 상태 ===== */
	.wo-status .state {
	    font-weight: 700;
	    color: #5a54dd;
	}
  
  /* 테이블 */
  .yeoun-table thead {
    background: #f5f3ff;
    color: #5b53a1;
  }

  .yeoun-table td {
    font-size: 13px;
  }

  /* 푸터 */
  .yeoun-modal-footer {
    border-top: 1px solid #eeeafc;
    padding: 16px 24px;
    text-align: right;
  }

  /* 입력폼 스타일 보완 */
  #workCreateForm .form-label {
    color: #6a63b9;
    font-weight: 600;
    font-size: 13px;
  }

  #workCreateForm .form-control,
  #workCreateForm .form-select {
    background: #faf9ff;
    border-color: #dcd6fe;
  }

  #workCreateForm .form-control:focus,
  #workCreateForm .form-select:focus {
    border-color: #6a5acd;
    box-shadow: 0 0 0 0.15rem rgba(106, 92, 205, 0.2);
  }

  /* info-value는 read-only 표현 */
  .info-value {
    background: #faf9ff;
    border: 1px solid #e3dfff;
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 14px;
    color: #4a436d;
  }

  .status-tag {
    font-weight: 600;
    color: #6a5acd;
  }

  /* 테이블 */
  .yeoun-table thead {
    background: #f5f3ff;
    color: #5b53a1;
  }
  
  /* 재고 */
  .stock-panel {
    width: 300px;
    background: #faf9ff;
    border-left: 1px solid #ddd;
    padding: 16px;
    overflow-y: auto;
    max-height: calc(100vh - 200px);
    border-radius: 8px;
	}
	.stock-item {
	    padding: 12px;
	    margin-bottom: 10px;
	    background: white;
	    border-radius: 8px;
	    border: 1px solid #eee;
	}
	.stock-item.low {
	    border-color: #ff6b6b;
	    background: #fff5f5;
	}
	.stock-item.ok {
	    border-color: #63c76a;
	    background: #f3fff5;
	}
  
  	.detail-select {
	    background-color: #fff;
	    border: 1px solid #d4caff;
	    border-radius: 8px;
	    padding: 5px;
	    font-size: 14px;
	    color: #444;
  	}

</style>
</head>
<body>
<th:block layout:fragment="content">
<div class="custom-body container-xxl flex-grow-1 container-p-y">
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <div class="title">
      <i class="bi bi-kanban-fill"></i>
      작업지시 관리
    </div>
    <button class="btn btn-yeoun-primary" id="btnCreate">
      <i class="bi bi-plus-circle"></i> 새로 등록
    </button>
  </div>
  <!-- ===== 왼쪽: 작업지시 목록 ===== -->
  <div>
    <div class="order-card">
      <div class="order-card-header">
        <div class="card-title">
          작업지시 목록
        </div>
        <span class="yeoun-badge-outline" th:text="|처리하지 않은 생산 계획이 ${plansLength}건 있습니다|">
        </span>
      </div>

      <!-- 검색 / 필터 영역 -->
      <div class="mb-2 search-row">
        <input id="searchKeyword" type="text" class="form-control" placeholder="품목명 / 작업지시 번호 검색" />
        <select id="searchStatus" class="form-select" style="max-width: 150px;">
          <option value="ALL">전체 상태</option>
          <option value="CREATED">준비</option>
          <option value="RELEASED">확정</option>
          <option value="IN_PROGRESS">진행</option>
          <option value="COMPLETED">완료</option>
          <option value="CANCELED">취소</option>
        </select>
        <input type="date" class="form-control" id="startDateFrom" style="max-width: 150px;" />
        <button id="btnSearchOrder" class="btn btn-sm btn-outline-secondary">
          <i class="las la-search drop-shadow fs-5"></i>
        </button>
      </div>

      <div id="workOrderGrid"></div>
    </div>
  </div>
</div>

  <!-- 모달 HTML -->
  <!-- =================================== 등록 모달 ========================================== -->
  <div class="modal fade" id="workCreateModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content yeoun-modal">

        <!-- Header -->
        <div class="yeoun-modal-header">
          <div class="modal-title-wrap">
            <h5 class="modal-title">작업지시 등록</h5>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Body -->
        <div class="yeoun-modal-body">
          <div class="flex-fill" id="workorder-form">
	          <form id="workCreateForm" th:object="${workOrderRequest}">
	          <input type="hidden" name="${_csrf.headerName}" value="${_csrf.token}">
	              <div class="alert alert-danger"
	                   th:if="${#fields.hasGlobalErrors()}">
	                  <p th:each="err : ${#fields.globalErrors()}"
	                     th:text="${err}"></p>
	              </div>
	
	              <div class="row g-3 mb-3">
	          		<div class="col-6">
	          			<label class="form-label">생산 계획서</label>
	          			<select th:field="*{planId}" class="form-select" style="color: red;">
	          				<option disabled th:selected="${planId == null}" value="" >생산 계획을 먼저 선택해주세요.</option>
	          				<th:block th:each="plan : ${plans}">
	          					<option th:value="${plan.planId}"
	          							th:text="${plan.planId}"
	          							th:data-name="${plan.itemName}"
	                                    th:data-remain="${plan.remainingQty}"
	          							th:data-total="${plan.totalQty}"
	          							style="color: #888;"
	          					></option>
	          				</th:block>
	          			</select>
	                    <div class="invalid-feedback"
	                         data-error-for="planId" style="display:none;">
	                        생산 계획은 필수 선택값입니다.
	                    </div>
	          		</div>
	          		<div class="col-3">
	          			<label class="form-label">품목 및 수량</label> <!-- view 용도. form 전송값 없음 -->
	          			<div id="planDetail" class="form-control">
	          				생산 계획을 선택해주세요.
	          			</div>
	          		</div>
	          		<div class="col-3">
	          			<label class="form-label">공정 코드(라우트)</label>
	          			<input type="text" class="form-control" th:field="*{routeId}" id="routeHeader"
	          				placeholder="생산 계획을 선택해주세요."/>
	<!--           			<div id="routeHeader" class="form-control">
	          				생산 계획을 선택해주세요.
	          			</div> -->
	          		</div>
	          	</div>
	
	            <!-- 품목 / 라인 -->
	            <div class="row g-3 mb-3">
	              <div class="col-4">
	                <label class="form-label">품목</label>
	                <select th:field="*{prdId}" class="form-select" id="prdName">
	                	<option value="" disabled th:selected="${prdId == null}">생산 계획을 선택해주세요.</option>
	                	<th:block th:each="prod : ${prods}">
	                		<option th:value="${prod.prdId}" th:text="${prod.prdName}"></option>
	                	</th:block>
	                </select>
	                  <div class="invalid-feedback"
	                       data-error-for="prdId" style="display:none;">
	                      품목은 필수 선택값입니다.
	                  </div>
	              </div>
	              <div class="col-4">
	                <label class="form-label">라인</label>
	                <select th:field="*{lineId}" class="form-select" id="line">
	                  <option value="" disabled th:selected="${lineId == null}">눌러서 선택</option>
	                  <th:block th:each="line : ${lines}">
	                  	<option th:value="${line.lineId}" th:text="${line.lineName}"></option>
	                  </th:block>
	                </select>
	                  <div class="invalid-feedback"
	                       data-error-for="lineId" style="display:none;">
	                      작업 라인은 필수 선택값입니다.
	                  </div>
	              </div>
	              <div class="col-4">
	                <label class="form-label">계획 수량</label>
	                <input th:field="*{planQty}" type="number" class="form-control" placeholder="예) 250">
	                  <div class="invalid-feedback"
	                       data-error-for="planQty" style="display:none;">
	                      수량은 필수 입력값입니다.
	                  </div>
	              </div>
	            </div>
	
	            <!-- 날짜 / 시간 -->
	            <div class="row g-3 mb-3">
	              <div class="col-3">
	          			<label class="form-label">예상 소요 시간</label>
	          			<div id="referTime" class="form-control">
	          				생산 계획을 선택해주세요.
	          			</div>
	              </div>
	              <div class="col-3">
	                <label class="form-label">계획 일자</label>
	                <input type="date" class="form-control" id="planDate">
	              </div>
	              <div class="col-3">
	                <label class="form-label">시작 시간</label>
	                <input type="time" class="form-control" id="startTime">
	                  <input type="hidden" th:field="*{planStartDate}">
	                  <div class="invalid-feedback"
	                       data-error-for="planStartDate" style="display:none;">
	                      시작 시간은 필수 입력값입니다.
	                  </div>
	              </div>
	              <div class="col-3">
	                <label class="form-label">종료 시간</label>
	                <input type="time" class="form-control" id="endTime">
	                  <input type="hidden" th:field="*{planEndDate}">
	                  <div class="invalid-feedback"
	                       data-error-for="planEndDate" style="display:none;">
	                      종료 시간은 필수 입력값입니다.
	                  </div>
	              </div>
	            </div>
	
	            
	            <div class="worker-flow-container">
				
				  <div class="flow-item">
				    <div class="flow-title">블렌딩</div>
				    <div class="flow-desc">혼합탱크·교반기</div>
				    <select th:field="*{prcBld}" class="flow-select" id="blendSelect">
				      <option value="" selected th:selected="${prcBld == null}">선택</option>
				      <th:block th:each="worker : ${workers}">
	                  	<option th:value="${worker.empId}"
	                  			th:text="|${worker.empName} (${worker.posName})|"
	                  	></option>
	                  </th:block>
				    </select>
	                  <div class="invalid-feedback"
	                       data-error-for="prcBld" style="display:none;">
	                      블렌딩 작업자를 선택해야 합니다.
	                  </div>
				  </div>
				  
				  <div class="flow-item">
				    <div class="flow-title">여과</div>
				    <div class="flow-desc">여과기</div>
				    <select th:field="*{prcFlt}" class="flow-select" id="filterSelect">
				      <option value=""  selected th:selected="${prcFlt == null}">선택</option>
				      <th:block th:each="worker : ${workers}">
	                  	<option th:value="${worker.empId}"
	                  			th:text="|${worker.empName} (${worker.posName})|"
	                  	></option>
	                  </th:block>
				    </select>
	                  <div class="invalid-feedback"
	                       data-error-for="prcFlt" style="display:none;">
	                      여과기 작업자를 선택해야 합니다.
	                  </div>
				  </div>
				
				  <div class="flow-item">
				    <div class="flow-title">충전</div>
				    <div class="flow-desc">충전기</div>
				    <select th:field="*{prcFil}" class="flow-select" id="fillSelect">
				      <option value="" selected th:selected="${prcFil == null}">선택</option>
				      <th:block th:each="worker : ${workers}">
	                  	<option th:value="${worker.empId}"
	                  			th:text="|${worker.empName} (${worker.posName})|"
	                  	></option>
	                  </th:block>
				    </select>
	                  <div class="invalid-feedback"
	                       data-error-for="prcFil" style="display:none;">
	                      충전기 작업자를 선택해야 합니다.
	                  </div>
				  </div>
				
				  <div class="flow-item">
				    <div class="flow-title">조립 + 캡핑</div>
				    <div class="flow-desc">반자동 캡핑기</div>
				    <select th:field="*{prcCap}" class="flow-select" id="cappingSelect">
				      <option value="" selected th:selected="${prcCap == null}">선택</option>
				      <th:block th:each="worker : ${workers}">
	                  	<option th:value="${worker.empId}"
	                  			th:text="|${worker.empName} (${worker.posName})|"
	                  	></option>
	                  </th:block>
				    </select>
	                  <div class="invalid-feedback"
	                       data-error-for="prcCap" style="display:none;">
	                      캡핑기 작업자를 선택해야 합니다.
	                  </div>
				  </div>
				
				  <div class="flow-item">
				    <div class="flow-title">라벨링 + 포장</div>
				    <div class="flow-desc">라벨러·포장기</div>
				    <select th:field="*{prcLbl}" class="flow-select" id="labelPackSelect">
				      <option value="" selected th:selected="${prcLbl == null}">선택</option>
				      <th:block th:each="worker : ${workers}">
	                  	<option th:value="${worker.empId}"
	                  			th:text="|${worker.empName} (${worker.posName})|"
	                  	></option>
	                  </th:block>
				    </select>
	                  <div class="invalid-feedback"
	                       data-error-for="prcLbl" style="display:none;">
	                      포장기 작업자를 선택해야 합니다.
	                  </div>
				  </div>
				
				</div>
	
	            
	            <!-- 비고 -->
	            <div class="mb-3">
	              <label class="form-label">비고</label>
	              <textarea th:field="*{remark}" class="form-control" rows="3" placeholder="특이사항, 주의사항 등을 입력하세요."
	              			style="resize: none;"
	              ></textarea>
	            </div>
	          </form>
          </div>
          <div class="stock-panel">
          
          </div>
        </div>

        <!-- Footer -->
        <div class="yeoun-modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
          <button type="button" class="btn btn-yeoun-primary" id="btnCreateSubmit">
            <i class="bi bi-check2-circle"></i> 저장
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- =============================== 상세 모달 ================================= -->
  <div class="modal fade" id="workDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content yeoun-modal">

        <!-- HEADER -->
        <div class="yeoun-modal-header">
          <div class="modal-title-wrap">
            <h5 class="modal-title" id="detailModalTitle">작업지시 상세</h5>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- BODY -->
        <div class="yeoun-modal-body">

				<div class ="wo-detail">
			
				    <!-- ===== 1. 헤더 라인 ===== -->
				    <div class="wo-header">
				        <div class="wo-no">
				            <label>작업지시번호</label>
				            <div class="value strong" id="detailOrderId"></div>
				        </div>
				        <div class="wo-item">
				            <label>품목명</label>
				            <div class="value" id="detailPrdName"></div>
				        </div>
				        <div class="wo-qty">
				            <label>계획 수량</label>
				            <div class="value" id="detailPlanQty"></div>
				        </div>
				    </div>
				    
				    <!-- ===== 2. 생산일자/시간 ===== -->
				    <div class="wo-row">
				        <div class="wo-col">
				            <label>생산 일자</label>
				            <div class="value" id="detailPlanDate"></div>
				        </div>
				        <div class="wo-col">
				            <label>생산 시간</label>
				            <div class="value" id="detailPlanTime"></div>
				        </div>
				    </div>
				    
				    <!-- ===== 3. 라인 / 공정 ===== -->
				    <div class="wo-row">
				        <div class="wo-col">
				            <label>할당 라인</label>
				            <div class="value" id="detailLineName"></div>
				        </div>
				        <div class="wo-col">
				            <label>진행 공정</label>
				            <div class="value" id="detailRouteId"></div>
				        </div>
				    </div>
				    
				    <!-- ===== 4. 공정별 작업자 ===== -->
				    <div class="wo-process-group">
				        <label>담당 작업자</label>
				        
			            <div class="process-line">
					        <div class="dot"></div>
					        <div class="dot"></div>
					        <div class="dot"></div>
					        <div class="dot"></div>
					        <div class="dot"></div>
					        <div class="dot"></div>
					    </div>
				
				        <div class="process-boxes">
				            <div class="proc">
				                <span class="proc-title">블렌딩</span>
				                <select class="proc-value detail-select" id="PRC-BLD" disabled>
							      <option value="">선택</option>
							      <th:block th:each="worker : ${workers}">
				                  	<option th:value="${worker.empId}"
				                  			th:text="${worker.empName}"
				                  	></option>
				                  </th:block>
							    </select>
				            </div>
				            <div class="proc">
				                <span class="proc-title">여과</span>
				                <select class="proc-value detail-select" id="PRC-FLT" disabled>
							      <option value="">선택</option>
							      <th:block th:each="worker : ${workers}">
				                  	<option th:value="${worker.empId}"
				                  			th:text="${worker.empName}"
				                  	></option>
				                  </th:block>
							    </select>
				            </div>
				            <div class="proc">
				                <span class="proc-title">충전</span>
				                <select class="proc-value detail-select" id="PRC-FIL" disabled>
							      <option value="">선택</option>
							      <th:block th:each="worker : ${workers}">
				                  	<option th:value="${worker.empId}"
				                  			th:text="${worker.empName}"
				                  	></option>
				                  </th:block>
							    </select>
				            </div>
				            <div class="proc">
				                <span class="proc-title">조립 + 캠핑</span>
				                <select class="proc-value detail-select" id="PRC-CAP" disabled>
							      <option value="">선택</option>
							      <th:block th:each="worker : ${workers}">
				                  	<option th:value="${worker.empId}"
				                  			th:text="${worker.empName}"
				                  	></option>
				                  </th:block>
							    </select>
				            </div>
				            <div class="proc">
				            	<span class="proc-title">QC</span>
				            	<select class="proc-value detail-select" disabled>
				            		<option value="" selected>품질 검사팀</option>
				            	</select>
				            </div>
				            <div class="proc">
				                <span class="proc-title">라벨링 + 포장</span>
				                <select class="proc-value detail-select" id="PRC-LBL" disabled>
							      <option value="">선택</option>
							      <th:block th:each="worker : ${workers}">
				                  	<option th:value="${worker.empId}"
				                  			th:text="${worker.empName}"
				                  	></option>
				                  </th:block>
							    </select>
				            </div>
				        </div>
				    </div>
				    
				    <!-- ===== 5. 상태 ===== -->
          			<div class="mb-3 wo-status">
				        <label class="form-label">상태</label>
				        <div class="value state" id="detailStatus"></div>
				    </div>
				    
				    <!-- ===== 6. 비고 ===== -->
				    <div class="mb-3">
		              <label class="form-label">비고</label>
		              <textarea id="detailRemark"
		              			class="form-control" rows="3"
		              			style="resize: none;" readonly
		              ></textarea>
		            </div>
				    
				    
		        <!-- FOOTER -->
		        <div class="yeoun-modal-footer">
		          <button id="btnReleased" class="btn">확정</button>
		          <button id="btnModify"   class="btn btn-warning">수정</button>
		          <button id="btnCanceled" class="btn btn-danger">취소</button>
		          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		        </div>
							
			</div>
         </div>

      </div>
    </div>


</th:block>

<th:block layout:fragment="myScript">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:if="${openCreateModal}">
    document.addEventListener("DOMContentLoaded", function () {
        const modalEl = document.getElementById('workCreateModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();   // 검증 실패 시 자동으로 모달 다시 열기
    });
</script>
<script>

  let workOrderGrid = null;

  document.addEventListener("DOMContentLoaded", () => {

    const gridEl = document.getElementById("workOrderGrid");
    if (!gridEl) {
      console.error("workOrderGrid 요소 없음!");
      return;
    }

    // 1) Grid 생성
    workOrderGrid = new tui.Grid ({
      el: gridEl,
      bodyHeight: 450,
      rowHeaders: ["rowNum"],
      scrollX: false,
      scrollY: true,
      pageOptions: {
        useClient: true,
        perPage: 10
      },
      columnOptions: {resizable: true},
      columns: [
        {header: "작업지시번호", name: "orderId", width: 160, align: "center"},
        {header: "품번", name: "prdId", align: "center"},
        {header: "품목군", name: "prdName", align: "left"},
        {header: "계획수량", name: "planQty", align: "right"},
        {
          header: "시작시간",
          name: "startDate",
          align: "center",
          formatter: ({ value }) => formatDate(value)
        },
        {
          header: "종료시간",
          name: "endDate",
          align: "center",
          formatter: ({ value }) => formatDate(value)
        },
        {
          header: "상태",
          name: "status",
          align: "center",
          formatter: ({ value }) => formatStatusBadge(value)
        },
        {header: "출고여부", name: "outboundYn", align: "center"},
        {
          header: "상세",
          name: "btn",
          width: 90,
          align: "center",
          formatter: () => "<button class='btn btn-primary btn-sm grid-detail'>상세</button>"
        }
      ]
    });

    // 2) 검색 버튼 클릭 시 조회
    document.getElementById("btnSearchOrder").addEventListener("click", () => {
        loadWorkOrderGrid();
    });

    // 3) 페이지 로드 시 전체 조회
    loadWorkOrderGrid();

    // 4) 상세 버튼 클릭 이벤트
    workOrderGrid.on("click", (event) => {
      if (event.columnName !== "btn") return;
      const row = workOrderGrid.getRow(event.rowKey);
      openDetailModal(row.orderId);
    });

  });

  // ======================================================
  // 작업지시 목록 조회
  // ======================================================
  function loadWorkOrderGrid(){
      const raw = document.getElementById("searchKeyword").value;

      const keyword = raw
          .trim()                 // 양쪽 공백 제거
          .replace(/\s+/g, " ")   // 여러 칸 띄어쓰기 → 하나로
          .toLowerCase();         // 소문자 통일
      const status  = document.getElementById("searchStatus").value  || "";
      const startDateFrom   = document.getElementById("startDateFrom").value || "";

    const query = new URLSearchParams({
      keyword,
      status,
    startDateFrom
    });

    fetch("/order/list/data?" + query.toString())
            .then(res => {
              if (!res.ok) throw new Error("HTTP " + res.status);
              return res.json();
            })
            .then(data => {
              console.log("작업지시 목록 : ", data);
              workOrderGrid.resetData(data);
            })
            .catch(err => {
              console.error("작업지시 목록 조회 오류", err);
              alert("조회 중 오류 발생");
            });

  }

  // 상태 뱃지 포맷
  function formatStatusBadge(status) {

    const map = {
      "CREATED":      { text: "준비",       cls: "status-badge status-create" },
      "RELEASED":     { text: "확정",       cls: "status-badge status-release" },
      "IN_PROGRESS":  { text: "진행중",     cls: "status-badge status-progress" },
      "COMPLETED":    { text: "완료",       cls: "status-badge status-complete" },
      "CANCELED":     { text: "취소",       cls: "status-badge status-cancel" }
    };

    const item = map[status] || { text: status, cls: "status-badge" };

    return `<span class="${item.cls}">${item.text}</span>`;
  }

  // 생산 일정 포맷
  function formatDate(dt) {
    if (!dt) return "-";

    // dt = "2025-12-04T09:00:00"
    const d = new Date(dt);

    if (isNaN(d.getTime())) return dt; // 잘못된 날짜면 원본 그대로

    const yy = String(d.getFullYear()).substring(2);
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");

    return `${yy}-${mm}-${dd} ${hh}:${mi}`;
  }

  // ====================================
  // 유효성 검증
  // ====================================
  function validateModalForm() {

      let valid = true;

      function showError(fieldName, condition) {
          const el = document.querySelector(`[name="${fieldName}"]`);
          const errBox = document.querySelector(`[data-error-for="${fieldName}"]`);

          if (!el || !errBox) return;

          if (condition) {
              el.classList.add("is-invalid");
              errBox.style.display = "block";
              valid = false;
          } else {
              el.classList.remove("is-invalid");
              errBox.style.display = "none";
          }
      }

      // ===========================
      // 필드별 검증
      // ===========================

      showError("planId", !document.querySelector(`[name="planId"]`).value);
      showError("routeId", !document.querySelector(`[name="routeId"]`).value);
      showError("prdId", !document.querySelector(`[name="prdId"]`).value);
      showError("lineId", !document.querySelector(`[name="lineId"]`).value);

      const qty = document.querySelector(`[name="planQty"]`).value;
      showError("planQty", !qty || qty <= 0);

      // 시간 검증
      const start = document.getElementById("startTime").value;
      const end   = document.getElementById("endTime").value;

      showError("planStartDate", !start);
      showError("planEndDate", !end);

      if (start && end) {
          const s = new Date(`2000-01-01T${start}`);
          const e = new Date(`2000-01-01T${end}`);
          showError("planEndDate", e <= s);  // 종료가 시작보다 이전이면 에러
      }

      // 작업자 검증
      showError("prcBld", !document.querySelector(`[name="prcBld"]`).value);
      showError("prcFlt", !document.querySelector(`[name="prcFlt"]`).value);
      showError("prcFil", !document.querySelector(`[name="prcFil"]`).value);
      showError("prcCap", !document.querySelector(`[name="prcCap"]`).value);
      showError("prcLbl", !document.querySelector(`[name="prcLbl"]`).value);

      return valid;
  }


  // ======================================================
  // 작업지시 등록 모달
  // ======================================================

  // 등록 모달 열기
  document.getElementById("btnCreate").addEventListener("click", () => {
    clearFormFields();
    const modal = new bootstrap.Modal(document.getElementById("workCreateModal"));
    modal.show();
  });
  
  let maxQty = null;

  // 생산계획서 정보 불러오기
  document.getElementById("planId").addEventListener("change", function() {
	    const option = this.selectedOptions[0];
	    const product = option.dataset.name;
	    const total = option.dataset.total;
        const remain = option.dataset.remain;
	    
	    maxQty = remain;	// 수량 저장
	    referTime = calcRecommendedHours(total);	// 소요시간 계산

	    document.getElementById("planDetail").innerText = `${product} (${remain} / ${total}개)`;
	    document.getElementById("referTime").innerText = referTime;
	    if (total < 336) {
	    	document.getElementById("planQty").value = total;
	    }
	    
	    const matchedOption = selectOptionByText("prdName", product);
	    let prdId;

	    if (matchedOption) {
	        prdId = matchedOption.value;
	        document.getElementById("routeHeader").value = `RT-${prdId}`;
	    }
	    
	    
	    fetch(`/order/check?prdId=${prdId}&planQty=${remain}`)
	    .then(res => res.json())
	    .then(list => renderStockPanel(list));
	});
  
  // 재고 렌더링
  function renderStockPanel(list) {
    const panel = document.querySelector('.stock-panel');
	    panel.innerHTML = "";
	
	    list.forEach(item => {
	        const shortage = item.requiredQty - item.stockQty;
	        const statusClass = shortage > 0 ? "low" : "ok";
	
	        panel.innerHTML += `
	            <div class="stock-item ${statusClass}">
	                <div><strong>${item.matName}</strong> (${item.matId})</div>
	                <div>필요량: ${item.requiredQty}</div>
	                <div>재고량: ${item.stockQty}</div>
	                ${shortage > 0 
	                    ? `<div style="color:#d63030;">부족: ${shortage}</div>` 
	                    : `<div style="color:#2ecc71;">충분</div>`}
	            </div>
	        `;
	    })
	}


  // 품목 자동 선택
  function selectOptionByText(selectId, text) {
	    const select = document.getElementById(selectId);
	    for (let option of select.options) {
	        if (option.text.trim() === text.trim()) {
	            option.selected = true;
	            return option;
	        }
	    }
	    return null;
	}
  
  // 계획 수량 제한
  document.getElementById("planQty").addEventListener("input", function () {
    if (maxQty && Number(this.value) > maxQty) {
        alert(`이 생산계획의 최대 수량은 ${maxQty}개입니다.`);
        this.value = maxQty;
    }
  });
  
  // 예상 소요 시간 계산
  function calcRecommendedHours(remain) {
	   const hours = remain / 42;
	   return "약 " + Math.ceil(remain / 42) + "시간(" + Math.round(hours * 10) / 10 + "시간) 소요 예상";
  }

  // 폼 전송(실제 등록 처리)
  document.getElementById("btnCreateSubmit").addEventListener("click", async () => {

      if (!validateModalForm()) return;

      const date = document.getElementById("planDate").value;
      const start = document.getElementById("startTime").value;
      const end = document.getElementById("endTime").value;

      if (date && start) {
          document.getElementById("planStartDate").value = `${date}T${start}`;
      }

      if (date && end) {
          document.getElementById("planEndDate").value = `${date}T${end}`;
      }

      const payload = {
          planId: document.querySelector('[name="planId"]').value,
          prdId:  document.querySelector('[name="prdId"]').value,
          lineId: document.querySelector('[name="lineId"]').value,
          routeId: document.querySelector('[name="routeId"]').value,
          planQty: document.querySelector('[name="planQty"]').value,
          planStartDate: document.getElementById("planStartDate").value,
          planEndDate:   document.getElementById("planEndDate").value,
          prcBld: document.querySelector('[name="prcBld"]').value,
          prcFlt: document.querySelector('[name="prcFlt"]').value,
          prcFil: document.querySelector('[name="prcFil"]').value,
          prcCap: document.querySelector('[name="prcCap"]').value,
          prcLbl: document.querySelector('[name="prcLbl"]').value,
          remark: document.querySelector('[name="remark"]').value
      };

      const res = await fetch("/order/create", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              [csrfHeader]: csrfToken
          },
          body: JSON.stringify(payload)
      });

      if (res.ok) {
          alert("등록이 완료되었습니다.");
          bootstrap.Modal.getInstance(document.getElementById("workCreateModal")).hide();
          loadWorkOrderGrid();  // 그리드 갱신
      } else {
          alert("등록 실패: 서버 오류");
      }
  });

  // 값 초기화
  function clearFormFields(){

      // ⬇ select, input 들 직접 초기화
      document.querySelector('select[name="planId"]').value = "";
      document.querySelector('select[name="prdId"]').value = "";
      document.querySelector('select[name="lineId"]').value = "";
      document.querySelector('input[name="routeId"]').value = "";
      document.querySelector('input[name="planQty"]').value = "";
      document.getElementById("planDate").value = "";
      document.getElementById("startTime").value = "";
      document.getElementById("endTime").value = "";

      // 작업자들
      document.querySelector('select[name="prcBld"]').value = "";
      document.querySelector('select[name="prcFlt"]').value = "";
      document.querySelector('select[name="prcFil"]').value = "";
      document.querySelector('select[name="prcCap"]').value = "";
      document.querySelector('select[name="prcLbl"]').value = "";

      // 표시용 텍스트도 초기화
      document.getElementById("planDetail").innerText = "생산 계획을 선택해주세요.";
      document.getElementById("referTime").innerText = "생산 계획을 선택해주세요.";
  }



  // ======================================================
  // 작업지시 상세 모달
  // ======================================================
  
	let orderId;
	  
  function openDetailModal(workId) {
    console.log("Detail:", workId);
    const modal = new bootstrap.Modal(document.getElementById("workDetailModal"));

    // 1) 기본 정보 로드
    fetch(`/order/detail/${workId}`)
            .then(res => res.json())
            .then(data => {
                console.log("정보:::: " , data);
                orderId = data.orderId;

                  document.getElementById("detailOrderId").innerText = data.orderId;
                  document.getElementById("detailPrdName").innerText = data.prdName;
                  document.getElementById("detailPlanQty").innerText = data.planQty;
                  document.getElementById("detailPlanDate").innerText = data.planDate;
                  document.getElementById("detailPlanTime").innerText = data.planTime;
                  document.getElementById("detailLineName").innerText = data.lineName;
                  document.getElementById("detailRouteId").innerText = data.routeId;
                  document.getElementById("detailRemark").value = data.remark;
                  
                  const dataStatus = data.status;
                  const statusBtn = document.getElementById("btnReleased");
                  const modifyBtn = document.getElementById("btnModify");
                  const cancelBtn = document.getElementById("btnCanceled");
                  const statusText = document.getElementById("detailStatus");
                  
                  if (dataStatus === "CREATED"){
                	  statusBtn.innerText = '확정';
                	  statusBtn.classList.add('btn-success');
                	  if (statusBtn.classList.contains('btn-info')){
                		  statusBtn.classList.remove('btn-info');
                	  }               	  
                	  statusText.innerText = '준비';
                	  statusBtn.disabled = false; // 확정버튼 활성화
                	  modifyBtn.disabled = false; // 수정버튼 활성화
                	  cancelBtn.disabled = false; // 취소버튼 활성화
                  } else {
                	  statusBtn.innerText = '확정됨';
                	  statusBtn.classList.add('btn-info');
                	  if (statusBtn.classList.contains('btn-success')){
                		  statusBtn.classList.remove('btn-success');
                	  }
                	  switch (dataStatus){
                	  	case "RELEASED":
                	  		statusText.innerText = '확정';
                	  		break;
                	  	case "IN_PROGRESS":
                	  		statusText.innerText = '진행중';
                	  		break;
                	  	case "COMPLETED":
                	  		statusText.innerText = '완료';
                	  		break;
                	  	case "CANCELED":
                	  		statusText.innerText = '취소';
                	  		break;
                	  	default:
                	  		statusText.innerText = '미정';
                	  }
                	  statusBtn.disabled = true; // 확정버튼 비활성화
                	  modifyBtn.disabled = true; // 수정버튼 비활성화
                	  cancelBtn.disabled = true; // 취소버튼 비활성화
                	  
                  }
                  

                  // 작업자 렌더링
                  data.infos.forEach(info => {
				    const select = document.getElementById(info.processId);  
				
				    if (!select) return;
				
				    // workerId가 null이면 선택값 없음
				    if (info.workerId) {
				        select.value = info.workerId;
				    } else {
				        select.value = ""; // '선택'
				    }
				    
				    if (dataStatus === "CREATED"){
				    	select.disabled = false;
				    	document.getElementById("detailRemark").readonly = false;
				    } else {
				    	select.disabled = true;
				    	document.getElementById("detailRemark").readonly = true;
				    }
				});


                  // 진행률 처리
                  updateProcessUI(data.infos);
            });

      modal.show();
  }
  
  // 상태 설정
  function updateProcessUI(workInfoList) {
	  
	const dots = document.querySelectorAll(".process-line .dot");
    const processLine = document.querySelector(".process-line");

    // 1) 점 상태 초기화
    dots.forEach(dot => dot.className = "dot");

    // 2) 점 색상 매핑
    workInfoList.forEach((step, i) => {
        const dot = dots[i];
        if (!dot) return;

        switch (step.status) {
            case "DONE":
                dot.classList.add("done");
                break;
            case "IN_PROGRESS":
                dot.classList.add("current");
                break;
            default:
                dot.classList.add("future");
        }
    });

    // 3) 진행률: COMPLETED 개수로 퍼센트 계산
    const completedCount = workInfoList.filter(s => s.status === "COMPLETED").length;
    const totalCount = workInfoList.length;
    const progressPercent = (completedCount / totalCount) * 100;

    // 4) CSS 변수로 선 색상 조절
    processLine.style.setProperty("--progress", progressPercent + "%");

}
  
  // 확정
  document.getElementById("btnReleased").addEventListener("click", async () => {
	  updateStatus(orderId, "RELEASED", "작업지시가 확정되었습니다.");
  });
  
  // 취소
  document.getElementById("btnCanceled").addEventListener("click", async() => {
	  if (!confirm("정말 취소하시겠습니까?")) return;
	  updateStatus(orderId, "CANCELED", "작업지시가 취소되었습니다.");
  });
  
  // 작업지시서 상태변경 공통 함수
  async function updateStatus (orderId, status, alertContent){
	  return fetch (`/order/status/${orderId}`, {
		  method: "PATCH",
		  headers: {
		      "Content-Type": "application/json",
		      [csrfHeader]: csrfToken
		  },
	      body: JSON.stringify({ status: status })
	  })
	  .then(res => {
		  if (!res.ok) throw new Error ("서버 오류 : " + res.status);
		  return res.text();
	  })
      .then(() => {
    	 alert(alertContent);
    	 
   		// 모달 닫기
   	    const modal = bootstrap.Modal.getInstance(document.getElementById("workDetailModal"));
   	    modal.hide();
   	    
   	    // 목록 새로고침
   	    loadWorkOrderGrid(); 
     })
     .catch(err => console.error("오류 발생:", err));
  }
  
</script>
</th:block>

</body>
</html>